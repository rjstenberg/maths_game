<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Maths gamification</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      background: #222;
      font-family: Arial, sans-serif;
    }

    /* Map container */
    .map-container {
      position: relative;
      width: 80vw;   /* Responsive width */
      max-width: 1000px;
    }

    .map-container img {
      width: 100%;
      height: auto;
      display: block;
    }

    /* Levels positioned relative to container */
    .level {
      position: absolute;
      width: 5%;           /* Scale with map */
      aspect-ratio: 1/1;   /* Keep square */
      border: 2px solid #000;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }

    .locked { background-color: red; cursor: not-allowed; }
    .open   { background-color: blue; }
    .done   { background-color: green; }

    .quiz-row {
  display: flex;
  gap: 20px; /* space between columns */
}
.quiz-col {
  display: flex;
  flex-direction: column;
  flex: 1;
}

.quiz-item {
  display: flex;
  align-items: center;
  gap: 6px;           /* space between question text and input */
  margin-bottom: 4px; /* space between rows */
}

.quiz-question {
  min-width: 70px;    /* enough for '10 ¬∑ 12 =' etc. */
  text-align: right;
    display: inline-block; /* ensures consistent width */
}

.quiz-input {
  width: 40px;        /* space for up to 3 digits */
  padding: 4px;
  font-size: 14px;
}

.star-icon {
  animation: twinkle 1.5s infinite alternate;
}

@keyframes twinkle {
  0% { transform: translate(-50%, -50%) scale(1); opacity: 0.7; }
  100% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
}

  </style>

  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>

  <div class="map-container">
    <img src="map.png" alt="Map">

    <!-- Example levels -->
    <div id="level1" class="level open" style="top: 6.6%; left: 23.9%;">1</div>
    <div id="level2" class="level locked" style="top: 6.6%; left: 51.7%;">2</div>
    <div id="level3" class="level locked" style="top: 6.6%; left: 66.1%;">3</div>
    <div id="level4" class="level locked" style="top: 26.7%; left: 66.2%;">4</div>
    <div id="levelBonus" class="level locked bonus" style="top: 43%; left: 57%; border-radius: 50%; width:5% ;">‚≠ê</div>    <!-- Bonus level -->
    <div id="level5" class="level locked" style="top: 86.1%; left: 24%;">5</div>
    <div id="level6" class="level locked" style="top: 86.1%; left: 51.8%;">6</div>
    <div id="level7" class="level locked" style="top: 71.4%; left: 78%;">7</div>
  </div>

  <script>
    const levels = document.querySelectorAll('.level');
    function loadProgress() {
  const stored = localStorage.getItem('levelProgress');
  if (!stored) return; // no saved progress

  const progress = JSON.parse(stored);
  levels.forEach((lvl, idx) => {
    lvl.classList.remove('locked','open','done');
    lvl.classList.add(progress[idx] || 'locked');
  });
  const savedAnimal = localStorage.getItem("bonusAnimal");
if (savedAnimal) {
  placeAnimalOnMap(savedAnimal);
  const bonusLvl = document.getElementById("levelBonus");
  bonusLvl.classList.remove("locked");
  bonusLvl.classList.add("done");
}

}

// Call it once after defining levels
loadProgress();

    let currentLevel = null;
    // Toggle: set true to shuffle questions for each level, false to keep original order
    const RANDOMIZE_QUESTIONS = false;

    const questionsByLevel = [
  [ // Level 1
    { q: "5 + 3 = ?", a: "8" },
    { q: "2 + 6 = ?", a: "8" },
    { q: "4 + 4 = ?", a: "8" },
    { q: "1 + 7 = ?", a: "8" }
  ],
  [ // Level 2
    { q: "10 - 4 = ?", a: "6" },
    { q: "12 - 5 = ?", a: "7" },
    { q: "9 - 3 = ?", a: "6" },
    { q: "8 - 2 = ?", a: "6" }
  ],
  [ // Level 3
    { q: "3 √ó 3 = ?", a: "9" },
    { q: "4 √ó 2 = ?", a: "8" },
    { q: "5 √ó 2 = ?", a: "10" },
    { q: "6 √ó 1 = ?", a: "6" }
  ]
];

// Optional fallback if a level has no questions
const defaultQuestionBank = [
  { q: "5 + 3 = ?", a: "8" },
  { q: "10 - 4 = ?", a: "6" },
  { q: "3 √ó 3 = ?", a: "9" }
];

function shuffleArray(arr) {
  // in-place shuffle
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
}

    // Attach click listeners
    levels.forEach((lvl, idx) => {
      lvl.addEventListener('click', () => {
    if (lvl.classList.contains('open') || lvl.classList.contains('done')) {
          currentLevel = idx;
          if (lvl.classList.contains('bonus')) {
      openAnimalSelector();
    } else {
      startQuiz();
    }
        }
      });
    });

function completeLevel(idx) {
  const lvl = levels[idx];
  lvl.classList.remove('open');
  lvl.classList.add('done');

  //check if level 4 is completed, unlock bonus level
  if (lvl.id == "level4") {
    //document.getElementById("levelBonus").classList.remove('locked');
    //document.getElementById("levelBonus").classList.add('open');
    levels[idx + 2].classList.remove('locked');
    levels[idx + 2].classList.add('open');
  }
  // unlock next
  if (levels[idx + 1]) { 
    levels[idx + 1].classList.remove('locked');
    levels[idx + 1].classList.add('open');
  }

  // Save progress to localStorage
  saveProgress();
}

function saveProgress() {
  const progress = Array.from(levels).map(lvl => {
    if (lvl.classList.contains('done')) return 'done';
    if (lvl.classList.contains('open')) return 'open';
    return 'locked';
  });
  localStorage.setItem('levelProgress', JSON.stringify(progress));
}

function generateMultiplicationQuestions(levelNum) {
  const questions = [];
  let startTable, endTable;

  if (levelNum === 1) {
    startTable = 1; endTable = 6;
  } else if (levelNum === 2) {
    startTable = 7; endTable = 12;
  } else {
    // fallback: levelNum tables starting at 1
    startTable = 1; endTable = 6;
  }

  for (let i = startTable; i <= endTable; i++) {
    for (let j = 0; j <= 10; j++) {
      questions.push({
        q: `${j} ¬∑ ${i} = ?`,
        a: (i * j).toString()
      });
    }
  }

  return questions;
}

function openAnimalSelector() {
  const animals = {
    "Hund": "üê∂",
    "Katt": "üê±",
    "Hamster": "üêπ",
    "Kanin": "üê∞",
    "Gris": "üê∑",
    "Fj√§ril": "ü¶ã"
  };

  const selectHTML = `
    <select id="animalSelect" class="swal2-select">
      <option value="" disabled selected>V√§lj ett djur</option>
      ${Object.keys(animals).map(a => `<option value="${a}">${a}</option>`).join('')}
    </select>
  `;

  Swal.fire({
    title: "Bonusniv√• üêæ",
    html: selectHTML,
    confirmButtonText: "Placera djur",
    showCancelButton: true,
    allowOutsideClick: false,
    width: "40%"
  }).then(result => {
    if (!result.isConfirmed) return;
    const animalType = document.getElementById('animalSelect').value;
    if (!animalType) return;

    placeAnimalOnMap(animalType, true); // true = save it
    //Swal.fire("Kul!", "Ditt djur har lagts till p√• kartan!", "success",);
    

    const bonusLvl = document.getElementById("levelBonus");
    bonusLvl.classList.remove('open');
    bonusLvl.classList.add('done');
    saveProgress?.();
  });
}
function placeAnimalOnMap(type, save = false) {
  const animals = {
    "Hund": "üê∂",
    "Katt": "üê±",
    "Hamster": "üêπ",
    "Kanin": "üê∞",
    "Gris": "üê∑",
    "Fj√§ril": "ü¶ã"
  };


  /*const positions = {
    "dog": { top: "70%", left: "20%" },
    "cat": { top: "40%", left: "60%" },
    "frog": { top: "80%", left: "75%" },
    "bird": { top: "25%", left: "30%" },
    "fish": { top: "50%", left: "50%" }
  };*/

  // Remove any existing animal icon before placing a new one
  const oldIcon = document.querySelector(".animal-icon");
  if (oldIcon) oldIcon.remove();

  const pos = {top: "53%", left: "15%"};

  //const pos = positions[type];
  //if (!pos) return;

  const icon = document.createElement("div");
  icon.classList.add("animal-icon");
  icon.textContent = animals[type];
  icon.style.position = "absolute";
  icon.style.top = pos.top;
  icon.style.left = pos.left;
  icon.style.fontSize = "5.5rem";
  icon.style.transform = "translate(-50%, -50%)";
  icon.style.pointerEvents = "none";
  icon.style.zIndex = "50";

  document.querySelector(".map-container").appendChild(icon);

  // Save to localStorage
  if (save) {
    localStorage.setItem("bonusAnimal", type);
  }
}

function placeStarsOnMap() {
  const starPositions = [
    { top: "5%", left: "5%" },
    { top: "5%", left: "95%" },
    { top: "95%", left: "5%" },
    { top: "95%", left: "95%" },
  ];

  const mapContainer = document.querySelector(".map-container");
  if (!mapContainer) return;

  // Add stars
  starPositions.forEach(pos => {
    const star = document.createElement("div");
    star.classList.add("star-icon");
    star.textContent = "‚≠ê"; // or üåü if you prefer
    star.style.position = "absolute";
    star.style.top = pos.top;
    star.style.left = pos.left;
    star.style.transform = "translate(-50%, -50%)";
    star.style.fontSize = "3rem";       // scales with map
    star.style.pointerEvents = "none";
    star.style.zIndex = "50";
    document.querySelector(".map-container").appendChild(star);
  });
    localStorage.setItem("starsPlaced", "true");
}


function startQuiz() {
  const levelNumber = currentLevel + 1; // 1-indexed

  // Generate questions per level
  function generateMultiplicationQuestions(levelNum) {
    const questions = [];
    let startTable, endTable;

    if (levelNum === 1) {
      startTable = 1; endTable = 6;
    } else if (levelNum === 2) {
      startTable = 7; endTable = 12;
    } else {
      startTable = 1; endTable = 6; // fallback
    }

    for (let i = startTable; i <= endTable; i++) {
      for (let j = 0; j <= 10; j++) {
        questions.push({ q: `${j} ¬∑ ${i} = ?`, a: (i * j).toString() });
      }
    }
    return questions;
  }

  let questions = generateMultiplicationQuestions(levelNumber);

  // optionally shuffle
  if (RANDOMIZE_QUESTIONS) questions.sort(() => 0.5 - Math.random());

  // Build multi-column HTML
  function buildQuizHTML(questions, tablesPerRow = 3) {
    // Group by table number
    const tables = {};
    questions.forEach(q => {
      const tableNum = parseInt(q.q.split('¬∑')[1].trim());
      if (!tables[tableNum]) tables[tableNum] = [];
      tables[tableNum].push(q);
    });

    const tableNums = Object.keys(tables).map(Number).sort((a,b) => a-b);

    let html = '<div class="quiz-grid">';
    for (let i = 0; i < tableNums.length; i += tablesPerRow) {
      html += '<div class="quiz-row">';
      const group = tableNums.slice(i, i + tablesPerRow);
      group.forEach(tNum => {
        html += '<div class="quiz-col">';
       tables[tNum].forEach(q => {
  html += `
    <div class="quiz-item">
      <span class="quiz-question">${q.q.replace('?', '')}</span>
      <input type="text" name="q${q.q}" data-answer="${q.a}" class="quiz-input" required>
    </div>
  `;
});

        html += '</div>'; // end quiz-col
      });
      html += '</div><br>'; // end row + space
    }
    html += '</div>';
    return html;
  }

  const quizHTML = buildQuizHTML(questions, 3);

  // Show SweetAlert2 quiz popup
  Swal.fire({
    title: `Niv√• ${levelNumber}`,
    html: quizHTML,
    focusConfirm: false,
    showCancelButton: true,
    allowOutsideClick: false,
    confirmButtonText: "R√§tta",
    cancelButtonText: 'Avbryt',

      width: '70%',           // wider than default
  customClass: {
    popup: 'quiz-popup'
  },

  preConfirm: () => {
  const inputs = Swal.getHtmlContainer().querySelectorAll("input[data-answer]");
  const answers = [];
  let correctCount = 0;

  inputs.forEach(inp => {
    const user = inp.value.trim();
    const correct = inp.dataset.answer.trim();
    const isCorrect = user === correct;
    answers.push({ q: inp.previousElementSibling.textContent, user, correct, isCorrect });
    if (isCorrect) correctCount++;
  });

  // return all info, not just the score
  return { score: correctCount / inputs.length, answers };
}
}).then(result => {
  if (!result.isConfirmed) return;

  const { score, answers } = result.value;
  const passed = score >= 0.75;
  const level = levels[currentLevel];
  const isAlreadyDone = level.classList.contains('done');

  // Filter to show only wrong answers
  const wrongAnswers = answers.filter(a => !a.isCorrect);

  // Build HTML feedback list (only wrong ones)
  let feedbackHTML = "";
  if (wrongAnswers.length === 0) {
    feedbackHTML = "<p>Alla svar var r√§tt! üéâ</p>";
  } else {
    feedbackHTML = "<div class='feedback-list'><p>Kom ih√•g till n√§sta g√•ng:</p>";
    wrongAnswers.forEach(a => {
      feedbackHTML += `
        <div>
          ${a.q} 
          <b style="color:green">${a.correct}</b>
        </div>`;
    });
    feedbackHTML += "</div>";
  }

  // Use your motivational text with feedback below it
  let title = passed ? "Snyggt jobbat!" : "Testa igen!";
const isLastLevel = currentLevel === levels.length -1;


  let text; 
  if (passed) {
    if (isLastLevel) {
    text = "üéâ Du har klarat hela spelet! Grattis!";
    placeStarsOnMap(); // add stars to background
    } else if (isAlreadyDone) {
      text = "Du klarade niv√•n igen.";
    } else {
      text = "Du har l√•st upp en ny niv√•.";
    }
  } else {
    text = "Inte riktigt d√§r √§n.";
  }

  Swal.fire({
    title,
    html: `<p>${text}</p><hr>${feedbackHTML}`,
    icon: passed ? "success" : "question",
    confirmButtonText: passed ? "OK" : "OK",
    width: "60%",
    allowOutsideClick: false
  }).then(() => {
    if (passed && !isAlreadyDone) completeLevel(currentLevel);
  });
});

if (isLastLevel && passed) {
  const starsDiv = document.createElement("div");
  starsDiv.classList.add("corner-stars");
  starsDiv.innerHTML = `
    <span class="star" style="top:0.5rem; left:0.5rem;">‚≠ê</span>
    <span class="star" style="top:0.5rem; right:0.5rem;">‚≠ê</span>
    <span class="star" style="bottom:0.5rem; left:0.5rem;">‚≠ê</span>
    <span class="star" style="bottom:0.5rem; right:0.5rem;">‚≠ê</span>
  `;
  document.body.appendChild(starsDiv);
}

}


// Cheat: fill answers when a key combo is pressed
(function() {
  const SEQ = ['ArrowLeft','ArrowRight','ArrowRight','ArrowLeft'];
  let buffer = [];

  function doCheatFill() {
  const container = Swal.getHtmlContainer?.();
  if (!container) {
    console.log('No quiz popup is open.');
    return;
  }

  const inputs = container.querySelectorAll('input[data-answer]');
  if (!inputs.length) {
    console.log('No quiz inputs found.');
    return;
  }

  inputs.forEach(inp => {
    inp.value = inp.dataset.answer;        // fill correct answer
    inp.style.backgroundColor = '#c8f7c5'; // highlight in light green
    inp.dispatchEvent(new Event('input', { bubbles: true }));
  });
}
 // Add the Cheat button dynamically
    const cheatBtn = document.createElement('button');
    cheatBtn.innerText = 'Cheat';
    cheatBtn.style = `
      position: fixed;
      bottom: 10px;
      left: 10px;
      padding: 6px 12px;
      background: orange;
      color: black;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      z-index: 9999;
    `;
    cheatBtn.addEventListener('click', (e) => {
      e.stopPropagation(); // prevent SweetAlert2 from closing the popup
      doCheatFill();
    });
    document.body.appendChild(cheatBtn);
    
  // Capture key sequence
  window.addEventListener('keydown', function(e) {
    const keyId = e.code || ('Key' + (e.key || '').toUpperCase());
    buffer.push(keyId);
    if (buffer.length > SEQ.length) buffer.shift();

    if (buffer.length === SEQ.length) {
      let match = true;
      for (let i = 0; i < SEQ.length; i++) if (buffer[i] !== SEQ[i]) match = false;
      if (match) {
        buffer = [];
        e.preventDefault?.();
        doCheatFill();
      }
    }
  }, true);
})();

  </script>
<button onclick="
localStorage.removeItem('levelProgress'); 
localStorage.removeItem('bonusAnimal');
localStorage.removeItem('starsPlaced');
location.reload();
" style="
position:fixed; 
bottom:10px; 
right:10px;
">Reset Progress
</button>


</body>
</html>