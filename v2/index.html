<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Maths gamification</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      background: #222;
      font-family: Arial, sans-serif;
    }

    /* Map container */
    .map-container {
      position: relative;
      width: 80vw;   /* Responsive width */
      max-width: 1000px;
    }

    .map-container img {
      width: 100%;
      height: auto;
      display: block;
    }

    /* Levels positioned relative to container */
    .level {
      position: absolute;
      width: 5%;           /* Scale with map */
      aspect-ratio: 1/1;   /* Keep square */
      border: 2px solid #000;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }

    .locked { background-color: red; cursor: not-allowed; }
    .open   { background-color: blue; }
    .done   { background-color: green; }

    .quiz-row {
  display: flex;
  gap: 20px; /* space between columns */
}
.quiz-col {
  display: flex;
  flex-direction: column;
  flex: 1;
}

.quiz-item {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 6px;           /* space between question text and input */
  margin-bottom: 4px; /* space between rows */
  text-align: center;
  width: 100%;
}

.quiz-question {
  min-width: 70px;    /* enough for '10 · 12 =' etc. */
  text-align: right;
    display: inline-block; /* ensures consistent width */
}

.quiz-input {
  width: 3em !important;        /* space for up to 3 digits */
  text-align: center;
  padding: 4px;
  font-size: 1em;
}

  </style>

  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>

  <div class="map-container">
    <img src="map.png" alt="Map">

    <!-- Example levels -->
    <div id="level1" class="level open" style="top: 6.6%; left: 23.9%;">3</div>
    <div id="level2" class="level locked" style="top: 6.6%; left: 51.7%;">4</div>
    <div id="level3" class="level locked" style="top: 6.6%; left: 66.1%;">5</div>
    <div id="level4" class="level locked" style="top: 26.7%; left: 66.2%;">6</div>
    <div id="level5" class="level locked" style="top: 86.1%; left: 24%;">7</div>
    <div id="level6" class="level locked" style="top: 86.1%; left: 51.8%;">8</div>
    <div id="level7" class="level locked" style="top: 71.4%; left: 78%;">9</div>

  </div>

  <script>
    const levels = document.querySelectorAll('.level');
    function loadProgress() {
  const stored = localStorage.getItem('levelProgress');
  if (!stored) return; // no saved progress

  const progress = JSON.parse(stored);
  levels.forEach((lvl, idx) => {
    lvl.classList.remove('locked','open','done');
    lvl.classList.add(progress[idx] || 'locked');
  });
}

// Call it once after defining levels
loadProgress();

    let currentLevel = null;
    // Toggle: set true to shuffle questions for each level, false to keep original order
    const RANDOMIZE_QUESTIONS = true;

// create levels 3–9 (each with 3×3 .. 9×9)
const questionsByLevel = [];

for (let table = 3; table <= 9; table++) {
  const levelQuestions = [];
  for (let i = 3; i <= 9; i++) {
    levelQuestions.push({
      q: `${table} × ${i} =`,
      a: String(table * i)
    });
  }
  questionsByLevel.push(levelQuestions);
}


// Optional fallback if a level has no questions
const defaultQuestionBank = [
  { q: "5 + 3 = ?", a: "8" },
  { q: "10 - 4 = ?", a: "6" },
  { q: "3 × 3 = ?", a: "9" }
];

function shuffleArray(arr) {
  // in-place shuffle
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
}

    // Attach click listeners
    levels.forEach((lvl, idx) => {
      lvl.addEventListener('click', () => {
    if (lvl.classList.contains('open') || lvl.classList.contains('done')) {
          currentLevel = idx;
          startQuiz();
        }
      });
    });

function completeLevel(idx) {
  levels[idx].classList.remove('open');
  levels[idx].classList.add('done');

  // unlock next
  if (levels[idx + 1]) {
    levels[idx + 1].classList.remove('locked');
    levels[idx + 1].classList.add('open');
  }

  // Save progress to localStorage
  saveProgress();
}

function saveProgress() {
  const progress = Array.from(levels).map(lvl => {
    if (lvl.classList.contains('done')) return 'done';
    if (lvl.classList.contains('open')) return 'open';
    return 'locked';
  });
  localStorage.setItem('levelProgress', JSON.stringify(progress));
}

function generateMultiplicationQuestions(levelNum) {
  const questions = [];
  let startTable, endTable;

  if (levelNum === 1) {
    startTable = 1; endTable = 6;
  } else if (levelNum === 2) {
    startTable = 7; endTable = 12;
  } else {
    // fallback: levelNum tables starting at 1
    startTable = 1; endTable = 6;
  }

  for (let i = startTable; i <= endTable; i++) {
    for (let j = 0; j <= 10; j++) {
      questions.push({
        q: `${j} · ${i} = ?`,
        a: (i * j).toString()
      });
    }
  }

  return questions;
}

function startQuiz() {
  // Generate questions per level
    const levelNumber = currentLevel + 1; // show human-readable number (1-indexed)
  const questions = questionsByLevel[currentLevel].slice(); // copy to avoid mutation
 // optionally shuffle
  if (RANDOMIZE_QUESTIONS) questions.sort(() => 0.5 - Math.random());

  // Build the form HTML
  let quizHTML = "<form id='quizForm' class='quiz-grid'>";
  questions.forEach((q, i) => {
    quizHTML += `
      <div class="quiz-item">
        <label>${q.q}</label>
        <input type="text" name="q${i}" data-answer="${q.a}" maxlength="3" class="swal2-input quiz-input" required>
      </div>
    `;
  });
  quizHTML += "</form>";
 

  // Show SweetAlert2 quiz popup
  Swal.fire({
    title: `Nivå ${levelNumber}`,
    html: quizHTML,
    focusConfirm: false,
    showCancelButton: true,
    confirmButtonText: "Rätta",
    cancelButtonText: 'Avbryt',
    width: '35%',
    allowOutsideClick: false, //prevent closing popup when clicking outside
    allowEscapeKey: false,  //prevent closing popup when using escape
    customClass: {
    popup: 'quiz-popup'
  },

    preConfirm: () => {
      const inputs = Swal.getHtmlContainer().querySelectorAll("input[data-answer]");
      let correct = 0;
      inputs.forEach(inp => {
        if (inp.value.trim() === inp.dataset.answer) correct++;
      });
      return correct / inputs.length;
    }
  }).then(result => {
    if (result.isConfirmed) {
      const score = result.value;
      if (score >= 0.75) {
        Swal.fire("Snyggt jobbat!", "Du har låst upp en ny nivå.", "success");
        completeLevel(currentLevel);
      } else {
        Swal.fire("Testa igen!", "Inte riktigt där än.", "question");
      }
    }
  });
}


// Cheat: fill answers when a key combo is pressed
(function() {
  const SEQ = ['ArrowLeft','ArrowRight','ArrowRight','ArrowLeft'];
  let buffer = [];

  function doCheatFill() {
  const container = Swal.getHtmlContainer?.();
  if (!container) {
    console.log('No quiz popup is open.');
    return;
  }

  const inputs = container.querySelectorAll('input[data-answer]');
  if (!inputs.length) {
    console.log('No quiz inputs found.');
    return;
  }

  inputs.forEach(inp => {
    inp.value = inp.dataset.answer;        // fill correct answer
    inp.style.backgroundColor = '#c8f7c5'; // highlight in light green
    inp.dispatchEvent(new Event('input', { bubbles: true }));
  });
}
 // Add the Cheat button dynamically
    const cheatBtn = document.createElement('button');
    cheatBtn.innerText = 'Cheat';
    cheatBtn.style = `
      position: fixed;
      bottom: 10px;
      left: 10px;
      padding: 6px 12px;
      background: orange;
      color: black;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      z-index: 9999;
    `;
    cheatBtn.addEventListener('click', (e) => {
      e.stopPropagation(); // prevent SweetAlert2 from closing the popup
      doCheatFill();
    });
    document.body.appendChild(cheatBtn);

  // Capture key sequence
  window.addEventListener('keydown', function(e) {
    const keyId = e.code || ('Key' + (e.key || '').toUpperCase());
    buffer.push(keyId);
    if (buffer.length > SEQ.length) buffer.shift();

    if (buffer.length === SEQ.length) {
      let match = true;
      for (let i = 0; i < SEQ.length; i++) if (buffer[i] !== SEQ[i]) match = false;
      if (match) {
        buffer = [];
        e.preventDefault?.();
        doCheatFill();
      }
    }
  }, true);
})();

  </script>
<button onclick="localStorage.removeItem('levelProgress'); location.reload();" style="position:fixed; bottom:10px; right:10px;">Reset Progress</button>


</body>
</html>