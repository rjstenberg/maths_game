<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Multiplikation tabell 3-9</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      background: #222;
      font-family: Arial, sans-serif;
    }

    /* Map container */
    .map-container {
      position: relative;
      width: 80vw;   /* Responsive width */
      max-width: 1000px;
    }

    .map-container img {
      width: 100%;
      height: auto;
      display: block;
    }

    /* Levels positioned relative to container */
    .level {
      position: absolute;
      width: 5%;           /* Scale with map */
      aspect-ratio: 1/1;   /* Keep square */
      border: 2px solid #000;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }

  .locked { background-color: red; cursor: not-allowed; }
  .open   { background-color: blue; }
  .done   { background-color: green; }

.quiz-row {
  display: flex;
  gap: 20px; /* space between columns */
}
.quiz-col {
  display: flex;
  flex-direction: column;
  flex: 1;
}

/* Shared grid layouts */
.quiz-grid-single {
  display: grid;
  grid-template-columns: 1fr;
  gap: 8px 0;
  justify-items: center;
  align-items: center;
}

.quiz-grid-final {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 10px 20px;
  justify-items: center;
  align-items: center;
}

/* Each question+input pair */
.quiz-item {
  display: flex;
  justify-content: center;  /* centers the entire pair */
  align-items: center;
  gap: 8px;
  width: 100%;
  text-align: center;
}

/* The question label */
.quiz-question {
  text-align: right;
  font-weight: 500;
  font-size: 1rem;
  min-width: 60px;          /* keep compact width */
}

/* The input field */
.quiz-input {
  width: 3em !important;
  text-align: center;
  padding: 4px 6px;
  font-size: 1rem;
  border: 1px solid #ccc;
  border-radius: 6px;
}

.star-icon {
  animation: twinkle 1.5s infinite alternate;
}

@keyframes twinkle {
  0% { transform: translate(-50%, -50%) scale(1); opacity: 0.7; }
  100% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
}

  </style>

  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>

  <div class="map-container">
    <img src="map.png" alt="Map">

    <!-- Example levels -->
    <div id="level1" class="level open" style="top: 6.6%; left: 23.9%;">3</div>
    <div id="level2" class="level locked" style="top: 6.6%; left: 51.7%;">4</div>
    <div id="level3" class="level locked" style="top: 6.6%; left: 66.1%;">5</div> <!-- Optional level -->
    <div id="level4" class="level locked" style="top: 26.7%; left: 66.2%;">6</div> <!-- Optional level -->
    <div id="levelBonus" class="level locked bonus" style="top: 18%; left: 86%; border-radius: 50%; width:5% ;">‚≠ê</div>    <!-- Bonus level -->
    <div id="level5" class="level locked" style="top: 46.5%; left: 38.5%;">7</div>
    <div id="level6" class="level locked" style="top: 86.1%; left: 24%;">8</div>
    <div id="level7" class="level locked" style="top: 86.1%; left: 51.8%;">9</div>
    <div id="level8" class="level locked" style="top: 71.4%; left: 76.7%;">üî•</div>

  </div>

<script>
const levels = document.querySelectorAll('.level');

const FINAL_TEST_BEST_TIME_KEY = "finalTestBestTime";

const animals = {
  "Hund": "üê∂",
  "Katt": "üê±",
  "Hamster": "üêπ",
  "Kanin": "üê∞",
  "Gris": "üê∑",
  "Fj√§ril": "ü¶ã"
};

function loadProgress() {
    const stored = localStorage.getItem('levelProgress');
    if (!stored) return; // no saved progress

    const progress = JSON.parse(stored);
    levels.forEach((lvl, idx) => {
      lvl.classList.remove('locked','open','done');
      lvl.classList.add(progress[idx] || 'locked');
    });
    const savedAnimal = localStorage.getItem("bonusAnimal");
    if (savedAnimal) {
      placeAnimalOnMap(savedAnimal);
      const bonusLvl = document.getElementById("levelBonus");
      bonusLvl.classList.remove("locked");
      bonusLvl.classList.add("done");
    }
  const starsPlaced = localStorage.getItem("starsPlaced");
  if (starsPlaced === "true")
  {
    placeStarsOnMap();
  }
}

// Call it once after defining levels
loadProgress();

    let currentLevel = null;
    // Toggle: set true to shuffle questions for each level, false to keep original order
    const RANDOMIZE_QUESTIONS = true;

  // create levels 3‚Äì9 (each with 3√ó3 .. 9√ó9)
const questionsByLevel = [];

for (let table = 3; table <= 10; table++) {
  const levelQuestions = [];
  for (let i = 3; i <= 9; i++) {
    levelQuestions.push({
      q: `${table} ¬∑ ${i} =`,
      a: String(table * i)
    });
  }
  questionsByLevel.push(levelQuestions);

  // duplicate table 7
  if (table === 7) {
    questionsByLevel.push([...levelQuestions]);
  }
}

function shuffleArray(arr) {
  // in-place shuffle
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
}

    // Attach click listeners
    levels.forEach((lvl, idx) => {
      lvl.addEventListener('click', () => {
    if (lvl.classList.contains('open') || lvl.classList.contains('done')) {
          currentLevel = idx;
          if (lvl.classList.contains('bonus')) {
      openAnimalSelector();
    } else {
      startQuiz();
    }
        }
      });
    });

function completeLevel(idx) {
  const lvl = levels[idx];
  lvl.classList.remove('open');
  lvl.classList.add('done');

  const next = levels[idx+1];

  // special rule
  if (lvl.id == "level2") {
    document.getElementById("level3").classList.remove('locked');
    document.getElementById("level3").classList.add('open');

    document.getElementById("level4").classList.remove('locked');
    document.getElementById("level4").classList.add('open');

    document.getElementById("level5").classList.remove('locked');
    document.getElementById("level5").classList.add('open');
  }
  else if (lvl.id === "level3" || lvl.id === "level4")
  {
    const bonus = document.getElementById("levelBonus");
    if (bonus.classList.contains("locked")) {
      bonus.classList.remove("locked");
      bonus.classList.add("open");
    }
  }
  else if (next) 
  { 
    next.classList.remove('locked');
    next.classList.add('open');
  }

  // Save progress to localStorage
  saveProgress();
}

function saveProgress() {
  //Each level's state
  const progress = Array.from(levels).map(lvl => {
    if (lvl.classList.contains('done')) return 'done';
    if (lvl.classList.contains('open')) return 'open';
    return 'locked';
  });
  localStorage.setItem('levelProgress', JSON.stringify(progress));

  //Placed animal
    const animalIcon = document.querySelector('.animal-icon');
  if (animalIcon) {
    // Find the emoji -> convert back to animal name if possible
    const emoji = animalIcon.textContent.trim();
    const animalName = animals[emoji] || emoji;
const savedAnimal = localStorage.getItem("bonusAnimal");
if (savedAnimal && animals[savedAnimal]) {
  placeAnimalOnMap(savedAnimal, false);
}  }

  // --- Save stars if they exist ---
  const starsPlaced = document.querySelectorAll('.star-icon').length > 0;
  localStorage.setItem('starsPlaced', starsPlaced ? 'true' : 'false');
}


function openAnimalSelector() {
  const selectHTML = `
    <select id="animalSelect" class="swal2-select">
      <option value="" disabled selected>V√§lj ett djur</option>
      ${Object.keys(animals).map(a => `<option value="${a}">${a}</option>`).join('')}
    </select>
  `;

  Swal.fire({
    title: "Bonusniv√• üêæ",
    html: selectHTML,
    confirmButtonText: "Placera djur",
    showCancelButton: true,
    allowOutsideClick: false,
    width: "40%"
  }).then(result => {
    if (!result.isConfirmed) return;
    const animalType = document.getElementById('animalSelect').value;
    if (!animalType) return;

    placeAnimalOnMap(animalType, true); // true = save it
    //Swal.fire("Kul!", "Ditt djur har lagts till p√• kartan!", "success",);
    

    const bonusLvl = document.getElementById("levelBonus");
    bonusLvl.classList.remove('open');
    bonusLvl.classList.add('done');
    saveProgress?.();
  });
}
function placeAnimalOnMap(type, save = true) {
  // Remove any existing animal icon before placing a new one
  const oldIcon = document.querySelector(".animal-icon");
  if (oldIcon) oldIcon.remove();

  const pos = {top: "53%", left: "15%"};

  const icon = document.createElement("div");
  icon.classList.add("animal-icon");
  icon.textContent = animals[type];
  icon.style.position = "absolute";
  icon.style.top = pos.top;
  icon.style.left = pos.left;
  icon.style.fontSize = "3rem";
  icon.style.transform = "translate(-50%, -50%)";
  icon.style.pointerEvents = "none";
  icon.style.zIndex = "50";

  document.querySelector(".map-container").appendChild(icon);

  // Save to localStorage
  if (save) {
    localStorage.setItem("bonusAnimal", type);
  }
}

function placeStarsOnMap() {
  const starPositions = [
    { top: "5%", left: "5%" },
    { top: "5%", left: "95%" },
    { top: "95%", left: "5%" },
    { top: "95%", left: "95%" },
  ];

  const mapContainer = document.querySelector(".map-container");
  if (!mapContainer) return;

  // Add stars
  starPositions.forEach(pos => {
    const star = document.createElement("div");
    star.classList.add("star-icon");
    star.textContent = "‚≠ê"; // or üåü if you prefer
    star.style.position = "absolute";
    star.style.top = pos.top;
    star.style.left = pos.left;
    star.style.transform = "translate(-50%, -50%)";
    star.style.fontSize = "3rem";       // scales with map
    star.style.pointerEvents = "none";
    star.style.zIndex = "50";
    document.querySelector(".map-container").appendChild(star);
  });
    localStorage.setItem("starsPlaced", "true");
}

// --- Generate 20 unique mixed questions evenly from tables 3‚Äì9 ---
// Avoids duplicates and reversed duplicates (e.g. 7√ó4 vs 4√ó7)
function getFinalTestQuestions() {
  const uniquePairs = new Set();
  const allQuestions = [];

  for (let a = 3; a <= 9; a++) {
    for (let b = 3; b <= 9; b++) {
      // create a normalized key so (4,7) == (7,4)
      const key = [Math.min(a, b), Math.max(a, b)].join('√ó');
      if (!uniquePairs.has(key)) {
        uniquePairs.add(key);
        allQuestions.push({
          q: `${a} ¬∑ ${b} =`,
          a: String(a * b)
        });
      }
    }
  }

  // shuffle all unique combinations
  shuffleArray(allQuestions);

  // pick first 20 for the final test
  return allQuestions.slice(0, 20);
}




function startQuiz() {
  const currentElement = levels[currentLevel]; // current level DOM element
  let questions;

  // --- Select questions ---
  if (currentElement.id === "level8") {
    // Final test: 20 unique questions from 3‚Äì9 tables
    questions = getFinalTestQuestions();
  } else {
    // Regular level
    questions = questionsByLevel[currentLevel].slice(); // copy to avoid mutation
  }

  // Optionally shuffle
  if (RANDOMIZE_QUESTIONS) shuffleArray(questions);

    // --- Build quiz HTML ---
  let quizHTML;
  if (currentElement.id === "level8") {
    // Final test: 4 columns + timer
    quizHTML = `
      <div style="margin-bottom:10px; font-weight:bold;">
        Tid kvar: <span id="finalTestTimer">03:00</span>
      </div>
      <form id='quizForm'><div class='quiz-grid-final'>`;
  } else {
    // Regular levels: 1 column
    quizHTML = "<form id='quizForm'><div class='quiz-grid-single'>";
  }

  questions.forEach((q, i) => {
    quizHTML += `
      <div class="quiz-item">
        <label class="quiz-question">${q.q}</label>
        <input type="text" name="q${i}" data-answer="${q.a}" maxlength="3" class="quiz-input" required>
      </div>
    `;
  });

  quizHTML += "</div></form>";

  // --- Title and instruction text ---
  let titleText = currentElement.id === "level8" ? "Finaltest üèÅ" : `Tabell ${questionsByLevel[currentLevel][0].q.split("¬∑")[0].trim()}`;
  let instructionText = currentElement.id === "level8" ? "Du beh√∂ver 18 r√§tt f√∂r att klara niv√•n." : "Du beh√∂ver 5 r√§tt f√∂r att klara niv√•n.";

  // --- Timer setup for final test ---
  let timeRemaining = 3 * 60; // 3 minutes in seconds
  let timerInterval;

  // --- Show SweetAlert2 quiz popup ---
  Swal.fire({
    title: titleText,
    html: `
      <p style="margin-top:-5px; font-size: 0.95em; color: #555;">${instructionText}</p>
      ${quizHTML}
    `,
    focusConfirm: false,
    showCancelButton: true,
    allowOutsideClick: false,
    allowEscapeKey: false,
    confirmButtonText: "R√§tta",
    cancelButtonText: 'Avbryt',
    width: currentElement.id === "level8" ? '60%' : '40%',
    customClass: { popup: 'quiz-popup' },
        didOpen: () => {
      // Start timer if final test
      if (currentElement.id === "level8") {
        const timerEl = Swal.getHtmlContainer()?.querySelector("#finalTestTimer");
        timerInterval = setInterval(() => {
          timeRemaining--;
          const min = Math.floor(timeRemaining / 60).toString().padStart(2,'0');
          const sec = (timeRemaining % 60).toString().padStart(2,'0');
          if (timerEl) timerEl.textContent = `${min}:${sec}`;

          if (timeRemaining <= 0) {
            clearInterval(timerInterval);
            Swal.close();
            Swal.fire({
              title: "Testa igen!",
              html: "Tiden √§r ute.",
              icon: "question",
              confirmButtonText: "OK",
              width: '60%'
            });
          }
        }, 1000);
      }
    },
    preConfirm: () => {
      const inputs = Swal.getHtmlContainer().querySelectorAll("input[data-answer]");
      const answers = [];
      let correctCount = 0;

      inputs.forEach(inp => {
        const user = inp.value.trim();
        const correct = inp.dataset.answer.trim();
        const isCorrect = user === correct;
        answers.push({ q: inp.previousElementSibling.textContent, user, correct, isCorrect });
        if (isCorrect) correctCount++;
      });

      return { answers, correctCount };
    }
  }).then(result => {
    if (!result.isConfirmed) {
          if (currentElement.id === "level8") clearInterval(timerInterval);
    return;
    }
    const { answers, correctCount } = result.value;
    // --- Stop timer ---
    if (currentElement.id === "level8") clearInterval(timerInterval);

    // --- Determine passing threshold ---
    const requiredCorrect = currentElement.id === "level8" ? 18 : 5;
    const passed = correctCount >= requiredCorrect;

    const level = levels[currentLevel];
    const isAlreadyDone = level.classList.contains('done');

    let popupTitle = passed ? "Snyggt jobbat!" : "Testa igen!";
let textBody = "";       // Motivational message
let feedbackHTML = "";   // Feedback section

const wrongAnswers = answers.filter(a => !a.isCorrect);

// --- Determine motivational text first ---
if (passed) {
  if (currentElement.id === "level8") {
    // Final test
    const timeUsed = 3*60 - timeRemaining;
    const previousBest = localStorage.getItem("finalTestBestTime");

    if (!previousBest) {
      textBody = "üéâ Du har klarat hela spelet! Grattis!"; // First pass
      localStorage.setItem("finalTestBestTime", timeUsed);
    } else {
      const bestTime = parseInt(previousBest);
      if (timeUsed < bestTime) {
        textBody = `üéâ Du klarade finaltestet igen, ${bestTime - timeUsed} sekunder snabbare √§n ditt rekord!`;
        localStorage.setItem("finalTestBestTime", timeUsed);
      } else if (timeUsed === bestTime) {
        textBody = "üéâ Du klarade finaltestet igen, p√• samma tid som ditt rekord!";
      } else {
        textBody = `üéâ Du klarade finaltestet igen!`;
      }
    }
    placeStarsOnMap();

  } else if (isAlreadyDone) {
    // Normal level already done
    textBody = "Du klarade niv√•n igen.";
  } else {
    // Normal level first pass
    textBody = "Du har l√•st upp en ny niv√•.";
  }

} else {
  // Did not pass
  textBody = "Inte riktigt d√§r √§n.";
}

// --- Build feedback separately ---
if (wrongAnswers.length === 0) {
  feedbackHTML = "<p>Alla r√§tt! üéâ</p>";
} else {
  feedbackHTML = "<div class='feedback-list'><p>T√§nk p√• till n√§sta g√•ng:</p>" +
    wrongAnswers.map(a => `<div>${a.q} <b style="color:green">${a.correct}</b></div>`).join("") +
    "</div>";
}

// --- Show popup ---
Swal.fire({
  title: popupTitle,
  html: `<p>${textBody}</p><hr>${feedbackHTML}`,
  icon: passed ? "success" : "question",
  confirmButtonText: "OK",
  width: currentElement.id === "level8" ? '60%' : '40%',
  allowOutsideClick: false
}).then(() => {
  if (passed && !isAlreadyDone) completeLevel(currentLevel);
});

  });
}



// Cheat: fill answers when a key combo is pressed
(function() {
  const SEQ = ['ArrowLeft','ArrowRight','ArrowRight','ArrowLeft'];
  let buffer = [];

  function doCheatFill() {
  const container = Swal.getHtmlContainer?.();
  if (!container) {
    console.log('No quiz popup is open.');
    return;
  }

  const inputs = container.querySelectorAll('input[data-answer]');
  if (!inputs.length) {
    console.log('No quiz inputs found.');
    return;
  }

  inputs.forEach(inp => {
    inp.value = inp.dataset.answer;        // fill correct answer
    inp.style.backgroundColor = '#c8f7c5'; // highlight in light green
    inp.dispatchEvent(new Event('input', { bubbles: true }));
  });
}
 // Add the Cheat button dynamically
 /*
    const cheatBtn = document.createElement('button');
    cheatBtn.innerText = 'Cheat';
    cheatBtn.style = `
      position: fixed;
      bottom: 10px;
      left: 10px;
      padding: 6px 12px;
      background: orange;
      color: black;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      z-index: 9999;
    `;
    cheatBtn.addEventListener('click', (e) => {
      e.stopPropagation(); // prevent SweetAlert2 from closing the popup
      doCheatFill();
    });
    document.body.appendChild(cheatBtn);
    */
  // Capture key sequence
  window.addEventListener('keydown', function(e) {
    const keyId = e.code || ('Key' + (e.key || '').toUpperCase());
    buffer.push(keyId);
    if (buffer.length > SEQ.length) buffer.shift();

    if (buffer.length === SEQ.length) {
      let match = true;
      for (let i = 0; i < SEQ.length; i++) if (buffer[i] !== SEQ[i]) match = false;
      if (match) {
        buffer = [];
        e.preventDefault?.();
        doCheatFill();
      }
    }
  }, true);
})();

  </script>
<button onclick="
localStorage.removeItem('levelProgress'); 
localStorage.removeItem('bonusAnimal');
localStorage.removeItem('starsPlaced');
localStorage.removeItem('finalTestBestTime');
location.reload();
" style="
position:fixed; 
bottom:10px; 
right:10px;
">Reset Progress
</button>


</body>
</html>